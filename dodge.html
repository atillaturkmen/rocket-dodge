<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rocket Dodge</title>
    <style>
        html,
        body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            background-color: #09daff;
        }
        canvas {
            background-color: #09daff;
            cursor: none;
        }

        #tutorial {
            position: fixed;
            display: block;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
            cursor: pointer;
        }
        #pause {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
        }
        #gameover {
            position: fixed;
            display: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2;
        }
        #text1 {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 45px;
            color: white;
            transform: translate(-50%,-50%);
            -ms-transform: translate(-50%,-50%);
        }
        #gameOverText {
            position: absolute;
            top: 50%;
            left: 50%;
            font-size: 50px;
            color: white;
            transform: translate(-50%,-50%);
            -ms-transform: translate(-50%,-50%);
        }
    </style>
</head>

<body onload = "initializeCanvas()">

    <div id="tutorial" onclick="startGame()">
        <div id="text1">Avoid red dots, make them collide with each other to gain points. Pause with esc, steer with arrows or wasd.<br><br>Click anywhere or press spacebar to start</div>
    </div>

    <div id="pause">
        <div id="text1">Press ESC to resume</div>
    </div>

    <div id="gameover">
        <div id="gameOverText"></div>
    </div>

    <script>
        const fps = 60; // frame number per second
        const speed = 10; // how many pixels the player moves in one frame  
        const missileColor = "red";
        const playerColor = "black";
        const playerHeadColor = "grey";
        const missileSize = 20;
        const difficulty = 1; // changes missile speed increse rate
        const rotateSpeed = 6;
        let missileInterval = 150;
        let missileSpeed = 4; // how many pixels missiles move in one frame

        let myGamePiece; // rocket that the player controls
        let missiles = []; // array which contains hostile missiles
        let keyBoardButtons = {
            left: [65, 37],
            up: [87, 38],
            right: [68, 39],
            down: [83, 40],
            esc: 27,
            space: 32,
        };
        let rightPressed, leftPressed, upPressed, downPressed, escPressed = false;
        let score = 0;
        let scoreCounter = new IntervalTimer(() => {score++}, 1000);
        let started = 0;

        //initializes the canvas element
        function initializeCanvas() {
            window.addEventListener('keydown', (event) => {
                if (event.keyCode == keyBoardButtons.space) {
                    startGame();
                }
            }, false);
            myGameArea.initialize();
        }
        //main function, starts the game
        function startGame() {
            document.getElementById("tutorial").style.display = "none";
            if (!started) {
                myGameArea.start(); // start the game
                started = 1;
            }
        }

        //contains canvas and canvas related methods
        var myGameArea = {
            canvas: document.createElement("canvas"), // create the canvas
            //initialize the canvas
            initialize: function () {
                this.canvas.width = window.innerWidth; // set canvas width to window width
                this.canvas.height = window.innerHeight; // set canvas height to window height
                this.context = this.canvas.getContext("2d"); // context field provides access to various useful canvas methods
                document.body.appendChild(this.canvas); // insert canvas into html
                myGamePiece = new player(10, 60, playerColor, playerHeadColor,225, 225); // initialize player
                myGamePiece.update();
                scoreCounter.pause();
            },
            //start game by starting interval
            start: function () {
                this.frameNo = 0; // this value increases with every frame from now on
                this.interval = new IntervalTimer(updateGameArea, 1000 / fps);
                //proccess pressed buttons
                window.addEventListener('keydown', keyDownHandler, false);
                window.addEventListener('keyup', keyUpHandler, false);
                scoreCounter.resume();
            },
            pause: function () {
                this.interval.pause();
                document.getElementById("pause").style.display = "block";
            },
            resume: function () {
                document.getElementById("pause").style.display = "none";
                this.interval.resume();
            },
            // stops update game area interval
            gameover: function () {
                this.interval.pause();
                scoreCounter.pause();
                document.getElementById("gameover").children[0].innerHTML = "GAME OVER<br>Your Score: " + score;
                document.getElementById("gameover").style.display = "block";
                window.removeEventListener('keydown', keyDownHandler, false);
                window.removeEventListener('keyup', keyUpHandler, false);
                window.addEventListener("keydown", (event) => {
                    if (event.keyCode == keyBoardButtons.space) {
                        location.reload();
                    }
                }, false);
            },
            // clears canvas
            clear: function () {
                this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
            }
        }

        function player(width, height, color, headColor, x, y) {
            this.width = width;
            this.height = height;
            this.speed = 0;
            this.angle = 0;
            this.moveAngle = 0;
            this.currentAngle = 0;
            this.x = x;
            this.y = y;
            this.update = function () {
                ctx = myGameArea.context;
                ctx.font = "30px Arial";
                ctx.fillStyle = "black";
                ctx.fillText("Score: " + score, 10, 50);
                ctx.save(); // save current canvas
                ctx.translate(this.x, this.y); // canvas origin is now x, y
                ctx.rotate(this.angle); // rotate the canvas so that rectangle rotates
                ctx.fillStyle = color; // set fill color
                ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height); // paint the rectangle
                ctx.fillStyle = headColor;
                ctx.fillRect(this.width / -2, this.height / -2, this.width, this.height / 5);
                ctx.restore(); //return previous state and attributes
            }
            // update component position
            this.newPos = function () {
                this.currentAngle += this.moveAngle;
                if (this.currentAngle < 0) {
                    this.currentAngle += 360;
                }
                else if (this.currentAngle >= 360) {
                    this.currentAngle -= 360;
                }
                this.angle += this.moveAngle * Math.PI / 180;
                this.x += this.speed * Math.sin(this.angle);
                this.y -= this.speed * Math.cos(this.angle);
            }
            // do not let player leave the screen
            this.inBounds = function () {
                if (myGamePiece.x < myGamePiece.height / 2) {
                    myGamePiece.speed = 0;
                    myGamePiece.x += 1;
                }
                if (myGamePiece.x > myGameArea.canvas.width - myGamePiece.height / 2) {
                    myGamePiece.speed = 0;
                    myGamePiece.x -= 1;
                }
                if (myGamePiece.y < myGamePiece.height / 2) {
                    myGamePiece.speed = 0;
                    myGamePiece.y += 1;
                }
                if (myGamePiece.y > myGameArea.canvas.height - myGamePiece.height / 2) {
                    myGamePiece.speed = 0;
                    myGamePiece.y -= 1;
                }
            }
            // check if this object crashes with other object
            this.crashWith = function (otherobj) {
                var myleft = this.x;
                var myright = this.x + (this.width / 10);
                var mytop = this.y;
                var mybottom = this.y + (this.height / 10);
                var otherleft = otherobj.x;
                var otherright = otherobj.x + (otherobj.width);
                var othertop = otherobj.y;
                var otherbottom = otherobj.y + (otherobj.height);
                var crash = true;
                if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                    crash = false;
                }
                return crash;
            }
        }

        function missile(width, height, color, x, y, speed) {
            this.width = width;
            this.height = height;
            this.speed = speed;
            this.angle = 0;
            this.moveAngle = 0;
            this.currentAngle = 0;
            this.x = x;
            this.y = y;
            this.update = function () {
                ctx = myGameArea.context;
                ctx.fillStyle = color;
                ctx.fillRect(this.x, this.y, this.width, this.height);
            }
            // updates component position
            this.newPos = function () {
                this.dx = myGamePiece.x - this.x;
                this.dy = myGamePiece.y - this.y;
                this.distance = Math.sqrt((this.dx*this.dx) + (this.dy*this.dy));
                this.x += this.speed * (this.dx/this.distance);
                this.y += this.speed * (this.dy/this.distance);
            }
            // this method checks if this object crashes with other object
            this.crashWith = function (otherobj) {
                var myleft = this.x;
                var myright = this.x + (this.width);
                var mytop = this.y;
                var mybottom = this.y + (this.height);
                var otherleft = otherobj.x;
                var otherright = otherobj.x + (otherobj.width);
                var othertop = otherobj.y;
                var otherbottom = otherobj.y + (otherobj.height);
                var crash = true;
                if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                    crash = false;
                }
                return crash;
            }
        }

        function updateGameArea() {
            // check if player collides with one of missiles
            for (i = 0; i < missiles.length; i++) {
                if (myGamePiece.crashWith(missiles[i])) {
                    myGameArea.gameover();
                    return;
                }
                for (j = 0; j < missiles.length; j++) {
                    if (i != j && missiles[i].crashWith(missiles[j])) {
                        missiles.splice(i, 1);
                        missiles.splice(j - 1, 1);
                        score += 10;
                    }
                }
            }
            myGameArea.clear();
            myGameArea.frameNo++;
            if ((window.innerWidth != myGameArea.canvas.width) || (window.innerHeight != myGameArea.canvas.height)) {
                myGameArea.canvas.width = window.innerWidth;
                myGameArea.canvas.height = window.innerHeight;
            }
            // create new hostile missile every initialMissileInterval frames
            if (everyinterval(missileInterval)) {
                let x;
                let y;
                if (Math.random() < 0.5) {
                    x = Math.random() * (-100);
                } else {
                    x = myGameArea.canvas.width + Math.random() * 100;
                }
                if (Math.random() < 0.5) {
                    y = Math.random() * (-100);
                } else {
                    y = myGameArea.canvas.height + Math.random() * 100;
                }
                missiles.push(new missile(missileSize, missileSize, missileColor, x, y, missileSpeed));
                missileSpeed += (difficulty / missileSpeed);
                missileInterval -= Math.round(missileInterval / 50);
            }

            myGamePiece.moveAngle = 0;
            myGamePiece.speed = 0;
            if (leftPressed && rightPressed) {
                myGamePiece.moveAngle = 0;
            } else if (leftPressed) {
                myGamePiece.moveAngle = -rotateSpeed;
            } else if (rightPressed) {
                myGamePiece.moveAngle = rotateSpeed;
            }
            if (upPressed) {
                myGamePiece.speed = speed;
            }
            // if (downPressed) {
            //     myGamePiece.speed = -speed;
            // }
            for (i = 0; i < missiles.length; i++) {
                missiles[i].newPos();
                missiles[i].update();
            }
            myGamePiece.inBounds();
            myGamePiece.newPos();
            myGamePiece.update();
        }

        function everyinterval(n) {
            if ((myGameArea.frameNo / n) % 1 == 0) {
                return true;
            }
            return false;
        }

        function keyDownHandler(event) {
            if (keyBoardButtons.right.includes(event.keyCode)) {
                event.preventDefault();
                rightPressed = true;
            }
            if (keyBoardButtons.left.includes(event.keyCode)) {
                event.preventDefault();
                leftPressed = true;
            }
            if (keyBoardButtons.down.includes(event.keyCode)) {
                event.preventDefault();
                downPressed = true;
            }
            if (keyBoardButtons.up.includes(event.keyCode)) {
                event.preventDefault();
                upPressed = true;
            }
            if (keyBoardButtons.esc == event.keyCode) {
                event.preventDefault();
                if (escPressed) {
                    myGameArea.resume();
                    scoreCounter.resume();
                    escPressed = false;
                }
                else {
                    myGameArea.pause();
                    scoreCounter.pause();
                    escPressed = true;
                }
            }
        }

        function keyUpHandler(event) {
            if (keyBoardButtons.right.includes(event.keyCode)) {
                rightPressed = false;
            }
            if (keyBoardButtons.left.includes(event.keyCode)) {
                leftPressed = false;
            }
            if (keyBoardButtons.down.includes(event.keyCode)) {
                downPressed = false;
            }
            if (keyBoardButtons.up.includes(event.keyCode)) {
                upPressed = false;
            }
        }
        
        function IntervalTimer(callback, interval) {
            var timerId, startTime, remaining = 0;
            var state = 0; //  0 = idle, 1 = running, 2 = paused, 3= resumed

            this.pause = function () {
                if (state != 1) return;

                remaining = interval - (new Date() - startTime);
                window.clearInterval(timerId);
                state = 2;
            };

            this.resume = function () {
                if (state != 2) return;

                state = 3;
                window.setTimeout(this.timeoutCallback, remaining);
            };

            this.timeoutCallback = function () {
                if (state != 3) return;

                callback();

                startTime = new Date();
                timerId = window.setInterval(callback, interval);
                state = 1;
            };

            startTime = new Date();
            timerId = window.setInterval(callback, interval);
            state = 1;
        }
    </script>

</body>

</html>
